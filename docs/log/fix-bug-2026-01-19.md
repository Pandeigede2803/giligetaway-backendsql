# Bug Fix Log - 19 Januari 2026

## Summary

Fix untuk masalah email round trip yang gagal di production.

---

## Issue #1: Round Trip Notification Gagal Tanpa Fallback

### Problem
- API `send-notification-round` gagal tanpa error handling yang memadai
- Tidak ada fallback email jika notification gagal
- Tidak ada alert ke Telegram untuk monitoring

### Root Cause
Di `sendInvoiceAndTicketEmailRoundTrip`, ketika notification API gagal:
- Hanya ada `console.error` tanpa detail
- Tidak ada backup email
- Tidak ada Telegram notification

### Solution
File: `util/sendInvoiceAndTicketEmail.js`

**Perubahan:**
1. Tambah detailed error logging
2. Tambah fallback backup email (`sendBackupEmailAlways2`)
3. Tambah Telegram alert untuk monitoring

```javascript
} catch (notificationError) {
  console.error("‚ùå Error sending round trip notification:", notificationError.message);
  console.error("üîç Notification error details:", notificationError.response?.data || notificationError.message);

  // Fallback: send backup email
  try {
    await sendBackupEmailAlways2(firstBooking);
    console.log("‚úÖ Backup email sent after round trip notification failed");
  } catch (backupErr) {
    console.error("‚ùå Failed to send backup email after notification failed:", backupErr.message);
  }

  // Send Telegram alert
  await sendTelegramError(`‚ùå <b>ROUNDTRIP NOTIFICATION FAILED</b>...`);
}
```

---

## Issue #2: Undefined `moment` di Telegram Alert

### Problem
- Telegram alert untuk backup email round trip error karena `moment` tidak di-import
- Menyebabkan error `moment is not defined`

### Root Cause
Kode menggunakan `moment(...)` langsung tanpa `require("moment")` di dalam template string.

### Solution
File: `util/sendInvoiceAndTicketEmail.js`

**Perubahan:**
Ganti `moment(date).format(...)` dengan raw date value:
```javascript
// Before
<li><strong>Travel Date:</strong> ${moment(firstBooking.booking_date).format("MMM D, YYYY")}</li>

// After
<li><strong>Travel Date:</strong> ${firstBooking.booking_date}</li>
```

---

## Issue #3: Guard Condition untuk Race Condition (Optional)

### Problem
Dokumentasi di `docs/race-condition-case.md` menjelaskan race condition dimana:
- DOKU mengirim response SUCCESS
- Handler langsung kirim email
- Data di database belum stabil

### Solution (Ditambahkan tapi bisa di-rollback)
File: `controllers/dokuController.js`

**Perubahan:**
Tambah guard condition di `handleRoundTripBooking`:
- Case 1: Validasi kedua booking berstatus `paid`
- Case 2: Validasi kedua transaksi ada
- Case 3: Validasi kedua transaksi berstatus `paid`

**Note:** Setelah analisis lebih lanjut, masalah utama bukan race condition tapi API notification yang error. Guard condition bisa di-rollback jika tidak diperlukan. Backup function tersedia di `handleRoundTripBooking2`.

---

## Files Changed

| File | Changes |
|------|---------|
| `util/sendInvoiceAndTicketEmail.js` | Fix moment undefined, add fallback & telegram alert |
| `controllers/dokuController.js` | Add guard condition (optional) |

---

## Commit Message

```
fix(email): improve round trip notification error handling

- Fix undefined moment error in Telegram alert template (use raw date)
- Add detailed error logging for round trip notification failures
- Add fallback backup email when notification API fails
- Add Telegram alert for round trip notification failures
```

---

## Testing Checklist

- [ ] Test round trip booking payment success
- [ ] Verify email terkirim ke customer
- [ ] Verify Telegram alert jika notification gagal
- [ ] Verify backup email terkirim jika notification gagal

---

## Related Documentation

- `docs/race-condition-case.md` - Dokumentasi kasus race condition
